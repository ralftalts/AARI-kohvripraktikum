import RPi.GPIO as GPIO
import time

# Led muutujad
auto_punane = 17
auto_kollane = 27
auto_roheline = 22
jk_punane = 5
jk_roheline = 6
nupp = 23           
nupp_tuli = 19

# Et asi töötaks
GPIO.setmode(GPIO.BCM)
GPIO.setwarnings(False)

for pin in [auto_punane, auto_kollane, auto_roheline, jk_punane, jk_roheline, nupp_tuli]:
    GPIO.setup(pin, GPIO.OUT)

GPIO.setup(nupp, GPIO.IN, pull_up_down=GPIO.PUD_UP)

# Misc. muutujad
nupp_pressed = False
last_nupp_state = GPIO.HIGH
last_press_time = 0
veaaeg = 0.3  # sekundites (300 ms)

try:
    while True:
        # pollimine
        current_state = GPIO.input(nupp)
        if current_state == GPIO.LOW and last_nupp_state == GPIO.HIGH:
            now = time.time()
            if now - last_press_time > veaaeg:
                nupp_pressed = True
                last_press_time = now
                GPIO.output(nupp_tuli, True)
                print("Nupp vajutatud!")

        last_nupp_state = current_state

# Foorid
        # Auto punane
        GPIO.output(auto_punane, True)
        GPIO.output(auto_kollane, False)
        GPIO.output(auto_roheline, False)

        # Jalakäija roheline
        if nupp_pressed:
            GPIO.output(jk_roheline, True)
            GPIO.output(jk_punane, False)
            time.sleep(5)  

            # Jalakäija roheline kustub
            GPIO.output(jk_roheline, False)
            GPIO.output(jk_punane, True)
            nupp_pressed = False
            GPIO.output(nupp_tuli, False)

        else:
            # Nuppu ei vajuta, ole punane
            GPIO.output(jk_roheline, False)
            GPIO.output(jk_punane, True)

        # Auto kollane
        GPIO.output(auto_punane, False)
        GPIO.output(auto_kollane, True)
        # Pollimine (sama kood mis enne)
        for _ in range(10):  
            current_state = GPIO.input(nupp)
            if current_state == GPIO.LOW and last_nupp_state == GPIO.HIGH:
                now = time.time()
                if now - last_press_time > veaaeg:
                    nupp_pressed = True
                    last_press_time = now
                    GPIO.output(nupp_tuli, True)
                    print("Nupp vajutatud!")
            last_nupp_state = current_state
            time.sleep(0.1)

        # Auto roheline
        GPIO.output(auto_kollane, False)
        GPIO.output(auto_roheline, True)
        # Pollimine (sama kood mis enne)
        for _ in range(50):
            current_state = GPIO.input(nupp)
            if current_state == GPIO.LOW and last_nupp_state == GPIO.HIGH:
                now = time.time()
                if now - last_press_time > veaaeg:
                    nupp_pressed = True
                    last_press_time = now
                    GPIO.output(nupp_tuli, True)
                    print("Nupp vajutatud!")
            last_nupp_state = current_state
            time.sleep(0.1)

        # Tgasi punaseks, kollane vilgub
        for _ in range(3):
            GPIO.output(auto_roheline, False)
            GPIO.output(auto_kollane, True)
            time.sleep(0.33)
            GPIO.output(auto_kollane, False)
            time.sleep(0.33)

# Tingimus lõpetamiseks, cleanup eemaldas lolle bugge
except KeyboardInterrupt:
    print("\nProgrammi katkestati käsitsi.")
finally:
    GPIO.cleanup()
    print("GPIO puhastatud ja programm suletud.")
