
import lgpio
import time

# GPIO määratlused (BCM numbrid)
AUTO_RED = 17
AUTO_YELLOW = 27
AUTO_GREEN = 22
PED_RED = 5
PED_GREEN = 6
BUTTON = 18
BUTTON_LIGHT = 19

# Ava GPIO kontroller
h = lgpio.gpiochip_open(0)

# Väljundid
for pin in [AUTO_RED, AUTO_YELLOW, AUTO_GREEN, PED_RED, PED_GREEN, BUTTON_LIGHT]:
    lgpio.gpio_claim_output(h, pin)
    lgpio.gpio_write(h, pin, 0)

# Nupp sisendiks
lgpio.gpio_claim_input(h, BUTTON)
lgpio.gpio_set_pull_up_down(h, BUTTON, lgpio.SET_PULL_UP)

# Muutujad
button_pressed = False

# Katkestuse funktsioon
def button_callback(chip, gpio, level, tick):
    global button_pressed
    if level == 0 and not button_pressed:  # FALLING
        button_pressed = True
        lgpio.gpio_write(h, BUTTON_LIGHT, 1)
        print("Nupp vajutatud!")

# Lisa katkestuse jälgimine
lgpio.gpio_set_alert_func(h, BUTTON, button_callback)

try:
    print("Foor töötab. Vajuta nuppu...")

    while True:
        # Autode punane
        lgpio.gpio_write(h, AUTO_RED, 1)
        lgpio.gpio_write(h, AUTO_YELLOW, 0)
        lgpio.gpio_write(h, AUTO_GREEN, 0)

        if button_pressed:
            lgpio.gpio_write(h, PED_GREEN, 1)
            lgpio.gpio_write(h, PED_RED, 0)
            time.sleep(5)
            button_pressed = False
            lgpio.gpio_write(h, BUTTON_LIGHT, 0)
        else:
            lgpio.gpio_write(h, PED_GREEN, 0)
            lgpio.gpio_write(h, PED_RED, 1)
            time.sleep(5)

        # Kollane
        lgpio.gpio_write(h, AUTO_RED, 0)
        lgpio.gpio_write(h, AUTO_YELLOW, 1)
        time.sleep(1)

        # Roheline
        lgpio.gpio_write(h, AUTO_YELLOW, 0)
        lgpio.gpio_write(h, AUTO_GREEN, 1)
        time.sleep(5)

        # Vilkuv kollane
        for _ in range(3):
            lgpio.gpio_write(h, AUTO_GREEN, 0)
            lgpio.gpio_write(h, AUTO_YELLOW, 1)
            time.sleep(0.33)
            lgpio.gpio_write(h, AUTO_YELLOW, 0)
            time.sleep(0.33)

except KeyboardInterrupt:
    print("\nProgrammi katkestati käsitsi.")
finally:
    lgpio.gpiochip_close(h)
    print("GPIO suletud ja programm lõpetatud.")
