import RPi.GPIO as GPIO
import time

# --- PINID ---
AUTO_RED = 17
AUTO_YELLOW = 27
AUTO_GREEN = 22
PED_RED = 5
PED_GREEN = 6
BUTTON = 23
BLUE = 16 

# --- GPIO seadistus ---
GPIO.setmode(GPIO.BCM)
GPIO.setwarnings(False)

for pin in [AUTO_RED, AUTO_YELLOW, AUTO_GREEN, PED_RED, PED_GREEN, BLUE]:
    GPIO.setup(pin, GPIO.OUT)
    GPIO.output(pin, GPIO.LOW)

GPIO.setup(BUTTON, GPIO.IN, pull_up_down=GPIO.PUD_UP)

# --- Globaalne muutujad ---
ped_request = False  # kas jalakäija on vajutanud
lock = False  # et vältida mitmekordset katkestust

# --- Katkestuse funktsioon ---
def button_pressed(channel):
    global ped_request, lock
    if not lock:
        ped_request = True
        lock = True
        GPIO.output(BLUE, GPIO.HIGH)  # süüta sinine tuli
        print("Nupp vajutatud!")

# --- Katkestuse registreerimine ---
GPIO.add_event_detect(BUTTON, GPIO.FALLING, callback=button_pressed, bouncetime=300)

try:
    GPIO.output(PED_RED, GPIO.HIGH)  # jalakäija punane alguses

    while True:
        # --- AUTODE PUNANE ---
        GPIO.output(AUTO_RED, GPIO.HIGH)
        GPIO.output(AUTO_YELLOW, GPIO.LOW)
        GPIO.output(AUTO_GREEN, GPIO.LOW)

        if ped_request:
            # Jalakäijate roheline süttib ainult sel perioodil
            GPIO.output(PED_RED, GPIO.LOW)
            GPIO.output(PED_GREEN, GPIO.HIGH)
        else:
            GPIO.output(PED_RED, GPIO.HIGH)
            GPIO.output(PED_GREEN, GPIO.LOW)

        time.sleep(5)

        # Pärast punast lõpetame jalakäijate tsükli
        GPIO.output(PED_GREEN, GPIO.LOW)
        GPIO.output(PED_RED, GPIO.HIGH)
        ped_request = False
        lock = False
        GPIO.output(BLUE, GPIO.LOW)

        # --- AUTODE KOLLANE ---
        GPIO.output(AUTO_RED, GPIO.LOW)
        GPIO.output(AUTO_YELLOW, GPIO.HIGH)
        time.sleep(1)

        # --- AUTODE ROHELINE ---
        GPIO.output(AUTO_YELLOW, GPIO.LOW)
        GPIO.output(AUTO_GREEN, GPIO.HIGH)
        time.sleep(5)

        # --- AUTODE KOLLANE VILKUMINE ---
        GPIO.output(AUTO_GREEN, GPIO.LOW)
        for _ in range(3):
            GPIO.output(AUTO_YELLOW, GPIO.HIGH)
            time.sleep(0.33)
            GPIO.output(AUTO_YELLOW, GPIO.LOW)
            time.sleep(0.33)

except KeyboardInterrupt:
    GPIO.cleanup()
    print("\nProgramm peatatud ja GPIO puhastatud.")
